name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 3.5.5 or 3.6.0-beta1)'
        required: true
        type: string
      create_tag:
        description: 'Create git tag'
        required: true
        type: boolean
        default: true
      prerelease:
        description: 'Mark as prerelease (for beta/alpha versions)'
        required: false
        type: boolean
        default: false

jobs:
  validate-release:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag_name: ${{ steps.version.outputs.tag_name }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Determine version
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "push" ]]; then
          # Extract version from tag
          VERSION=${GITHUB_REF#refs/tags/v}
          TAG_NAME=$GITHUB_REF_NAME
          
          # Auto-detect prerelease from version string
          if [[ "$VERSION" =~ (alpha|beta|rc|dev|pre) ]]; then
            IS_PRERELEASE="true"
          else
            IS_PRERELEASE="false"
          fi
        else
          # Use manual input
          VERSION="${{ github.event.inputs.version }}"
          TAG_NAME="v$VERSION"
          IS_PRERELEASE="${{ github.event.inputs.prerelease }}"
        fi
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
        echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
        echo "Release version: $VERSION"
        echo "Tag name: $TAG_NAME"
        echo "Is prerelease: $IS_PRERELEASE"
        
    - name: Validate version format
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        IS_PRERELEASE="${{ steps.version.outputs.is_prerelease }}"
        
        # Allow prerelease formats: X.Y.Z-alpha1, X.Y.Z-beta1, X.Y.Z-rc1, X.Y.Z-dev
        if [[ "$IS_PRERELEASE" == "true" ]]; then
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+-(alpha|beta|rc|dev)[0-9]*$ ]]; then
            echo "âœ— Invalid prerelease version format: $VERSION"
            echo "Expected formats: X.Y.Z-alpha1, X.Y.Z-beta1, X.Y.Z-rc1, X.Y.Z-dev"
            exit 1
          fi
          echo "âœ“ Prerelease version format is valid: $VERSION"
        else
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âœ— Invalid stable version format: $VERSION (expected: X.Y.Z)"
            exit 1
          fi
          echo "âœ“ Stable version format is valid: $VERSION"
        fi
        
    - name: Check TOC version consistency
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        IS_PRERELEASE="${{ steps.version.outputs.is_prerelease }}"
        TOC_VERSION=$(grep "## Version:" Name2Chat.toc | cut -d' ' -f3)
        
        # For prereleases, allow TOC version to be different (development version)
        if [[ "$IS_PRERELEASE" == "true" ]]; then
          echo "â„¹ï¸ Prerelease detected - skipping TOC version check"
          echo "TOC version: $TOC_VERSION, Release version: $VERSION"
        else
          if [[ "$TOC_VERSION" != "$VERSION" && "$TOC_VERSION" != "@project-version@" ]]; then
            echo "âœ— Version mismatch: TOC ($TOC_VERSION) != Release ($VERSION)"
            echo "For stable releases, TOC version must match or use @project-version@ placeholder"
            exit 1
          fi
          echo "âœ“ TOC version is compatible with release version: $VERSION"
        fi

  create-tag:
    name: Create Git Tag
    runs-on: ubuntu-latest
    needs: validate-release
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.create_tag == 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Create and push tag
      run: |
        TAG_NAME="${{ needs.validate-release.outputs.tag_name }}"
        VERSION="${{ needs.validate-release.outputs.version }}"
        IS_PRERELEASE="${{ needs.validate-release.outputs.is_prerelease }}"
        
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        
        # Create appropriate tag message
        if [[ "$IS_PRERELEASE" == "true" ]]; then
          git tag -a "$TAG_NAME" -m "Prerelease version $VERSION"
          echo "âœ“ Created prerelease tag: $TAG_NAME"
        else
          git tag -a "$TAG_NAME" -m "Release version $VERSION"
          echo "âœ“ Created release tag: $TAG_NAME"
        fi
        
        git push origin "$TAG_NAME"

  package-addon:
    name: Package Addon
    runs-on: ubuntu-latest
    needs: validate-release
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for proper changelog generation
        
    - name: Update version in TOC file
      run: |
        VERSION="${{ needs.validate-release.outputs.version }}"
        echo "Updating version placeholder in TOC file to: $VERSION"
        sed -i "s/@project-version@/$VERSION/g" Name2Chat.toc
        
        # Verify the version was updated
        echo "Updated TOC version line:"
        grep "## Version:" Name2Chat.toc
        
    - name: Validate TOC file structure
      run: |
        echo "Validating TOC file structure for BigWigs Packager..."
        
        # Check if required TOC metadata is present
        if ! grep -q "## X-Curse-Project-ID:" Name2Chat.toc; then
          echo "âš ï¸ Missing X-Curse-Project-ID in TOC file"
        fi
        
        if ! grep -q "## X-WoWI-ID:" Name2Chat.toc; then
          echo "âš ï¸ Missing X-WoWI-ID in TOC file"
        fi
        
        if ! grep -q "## X-Wago-ID:" Name2Chat.toc; then
          echo "âš ï¸ Missing X-Wago-ID in TOC file"
        fi
        
        # Validate interface versions
        echo "Checking interface version format..."
        RETAIL_INTERFACE=$(grep "## Interface-Retail:" Name2Chat.toc | cut -d' ' -f3 || grep "## Interface:" Name2Chat.toc | head -1 | cut -d' ' -f3)
        CLASSIC_INTERFACE=$(grep "## Interface-Classic:" Name2Chat.toc | cut -d' ' -f3)
        
        echo "Found interfaces: Retail=$RETAIL_INTERFACE, Classic=$CLASSIC_INTERFACE"
        
    - name: Install luacheck (optional validation)
      run: |
        sudo apt-get update
        sudo apt-get install -y lua5.1 luarocks
        sudo luarocks install luacheck
        
    - name: Run luacheck (non-blocking)
      run: |
        echo "Running luacheck for code quality (non-blocking)..."
        luacheck --no-color --codes Name2Chat.lua || echo "Luacheck found issues, but continuing with build..."
        
    - name: Package with BigWigs Packager
      uses: BigWigsMods/packager@v2
      with:
        args: -S  # Create multi-version TOCs automatically
      env:
        CF_API_KEY: ${{ secrets.CF_API_KEY }}
        WAGO_API_TOKEN: ${{ secrets.WAGO_API_TOKEN }}
        WOWI_API_TOKEN: ${{ secrets.WOWI_API_TOKEN }}
        GITHUB_OAUTH: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Manual package fallback
      if: failure()
      run: |
        echo "BigWigs Packager failed, creating manual fallback package..."
        VERSION="${{ needs.validate-release.outputs.version }}"
        PACKAGE_NAME="Name2Chat-$VERSION"
        
        echo "Creating manual release package: $PACKAGE_NAME"
        
        # Create temporary directory for packaging
        mkdir -p temp_package/Name2Chat
        
        # Copy addon files (version already updated earlier)
        cp Name2Chat.toc temp_package/Name2Chat/
        cp Name2Chat.lua temp_package/Name2Chat/
        cp embeds.xml temp_package/Name2Chat/ 2>/dev/null || echo "No embeds.xml found"
        cp locale.xml temp_package/Name2Chat/ 2>/dev/null || echo "No locale.xml found"
        
        # Copy locale directory if it exists
        if [ -d "lang" ]; then
          cp -r lang temp_package/Name2Chat/
        fi
        
        # Copy documentation
        cp README.md temp_package/Name2Chat/ 2>/dev/null || echo "No README.md found"
        cp CHANGELOG.md temp_package/Name2Chat/ 2>/dev/null || echo "No CHANGELOG.md found"
        cp LICENSE temp_package/Name2Chat/ 2>/dev/null || echo "No LICENSE found"
        
        # Create ZIP package
        cd temp_package
        zip -r "../$PACKAGE_NAME.zip" Name2Chat/
        cd ..
        
        # Verify package contents
        echo "Package contents:"
        unzip -l "$PACKAGE_NAME.zip"
        
        # Store package info for GitHub release
        echo "package_name=$PACKAGE_NAME" >> $GITHUB_ENV
        echo "package_file=$PACKAGE_NAME.zip" >> $GITHUB_ENV
        
    - name: Upload manual package artifact
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: Name2Chat-${{ needs.validate-release.outputs.version }}-manual
        path: "*.zip"
        retention-days: 90
        
    - name: Upload BigWigs package artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: Name2Chat-${{ needs.validate-release.outputs.version }}-bigwigs
        path: ".release/*.zip"
        retention-days: 90

  create-github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate-release, package-addon]
    if: always() && needs.validate-release.result == 'success'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download BigWigs package artifact
      uses: actions/download-artifact@v4
      with:
        name: Name2Chat-${{ needs.validate-release.outputs.version }}-bigwigs
        path: ./artifacts
      continue-on-error: true
        
    - name: Download manual package artifact
      if: failure()
      uses: actions/download-artifact@v4
      with:
        name: Name2Chat-${{ needs.validate-release.outputs.version }}-manual
        path: ./artifacts
      continue-on-error: true
        
    - name: Find package files
      id: find_package
      run: |
        echo "Looking for package files in artifacts directory..."
        ls -la ./artifacts/ || echo "No artifacts directory found"
        
        # Find the actual package file
        PACKAGE_FILE=$(find ./artifacts -name "*.zip" | head -1)
        if [ -n "$PACKAGE_FILE" ]; then
          echo "Found package file: $PACKAGE_FILE"
          echo "package_file=$PACKAGE_FILE" >> $GITHUB_OUTPUT
          
          # Extract package name for display
          PACKAGE_NAME=$(basename "$PACKAGE_FILE" .zip)
          echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
        else
          echo "No package file found!"
          exit 1
        fi
        
    - name: Generate release notes
      id: release_notes
      run: |
        VERSION="${{ needs.validate-release.outputs.version }}"
        IS_PRERELEASE="${{ needs.validate-release.outputs.is_prerelease }}"
        
        # Generate different release notes for prereleases
        if [[ "$IS_PRERELEASE" == "true" ]]; then
          cat > release_notes.md << EOF
        ## Name2Chat v$VERSION (Prerelease)
        
        ### âš ï¸ **Prerelease Version - Use with Caution**
        
        This is a **prerelease version** for testing purposes. It may contain bugs or incomplete features.
        
        **Version:** $VERSION  
        **Status:** ðŸ§ª **Testing/Development**  
        **Compatible with:** Retail, Classic Era, Burning Crusade Classic, Wrath Classic, Cataclysm Classic
        
        ### ðŸ§ª Testing Instructions
        1. **Backup your settings** before installing
        2. Download the \`${{ steps.find_package.outputs.package_name }}.zip\` file below
        3. Extract to your World of Warcraft \`_retail_/Interface/AddOns/\` directory
        4. Test thoroughly and report issues on GitHub
        
        ### âš¡ What's New in this Prerelease
        - This version contains changes not yet included in a stable release
        - Please test all functionality before using in important content
        - Report any issues at: https://github.com/gOOvER/Name2Chat/issues
        
        ### ðŸ”§ Features (Current)
        - âœ… Automatically adds your name to chat messages
        - âœ… Multi-version WoW support (Retail + All Classic versions)
        - âœ… Configurable chat types (Guild, Party, Raid, Instance, Custom channels)
        - âœ… Smart command detection (ignores messages starting with !)
        - âœ… Character name matching options
        
        ### âš ï¸ **Important Notes**
        - **Not recommended for production use**
        - **May contain breaking changes**
        - **Settings may not be compatible with stable versions**
        - **Use at your own risk**
        
        ### ðŸ”— Links
        - **Stable Releases:** [GitHub Releases](https://github.com/gOOvER/Name2Chat/releases)
        - **Report Issues:** [GitHub Issues](https://github.com/gOOvER/Name2Chat/issues)
        - **Website:** https://www.goover.dev
        
        ---
        
        **âš ï¸ Prerelease Version:** Not suitable for production use  
        **Changelog:** Compare changes at https://github.com/gOOvER/Name2Chat/compare/v$VERSION
        EOF
        else
          cat > release_notes.md << EOF
        ## Name2Chat v$VERSION
        
        ### ðŸŽ® WoW Addon - Chat Enhancement
        
        **Version:** $VERSION  
        **Compatible with:** Retail, Classic Era, Burning Crusade Classic, Wrath Classic, Cataclysm Classic
        
        ### ðŸ“¦ Installation
        1. Download the \`${{ steps.find_package.outputs.package_name }}.zip\` file below
        2. Extract to your World of Warcraft \`_retail_/Interface/AddOns/\` directory
        3. For Classic versions, extract to the appropriate AddOns directory
        4. Restart World of Warcraft
        5. Configure via \`/n2c config\` in-game
        
        ### ðŸ”§ Features
        - âœ… Automatically adds your name to chat messages
        - âœ… Multi-version WoW support (Retail + All Classic versions)
        - âœ… Configurable chat types (Guild, Party, Raid, Instance, Custom channels)
        - âœ… Smart command detection (ignores messages starting with !)
        - âœ… Character name matching options
        - âœ… Professional packaging with BigWigs Packager
        
        ### ðŸ“‹ Supported Interface Versions
        | WoW Version | Interface | Status |
        |-------------|-----------|--------|
        | **Retail (The War Within)** | 110205 | âœ… Fully Supported |
        | **Classic Era** | 11508 | âœ… Fully Supported |
        | **Burning Crusade Classic** | 20504 | âœ… Fully Supported |
        | **Wrath Classic** | 30403 | âœ… Fully Supported |
        | **Cataclysm Classic** | 40400 | âœ… Fully Supported |
        
        ### ðŸ”— Platform Links
        - **Website:** https://www.goover.dev
        - **CurseForge:** [Project 261826](https://www.curseforge.com/wow/addons/name2chat)
        - **WoWInterface:** [Addon 24357](https://www.wowinterface.com/downloads/info24357-Name2Chat.html)
        - **Wago:** [Project Qb6mWqGP](https://addons.wago.io/addons/name2chat)
        
        ### ðŸ“ Configuration Commands
        - \`/n2c\` or \`/Name2Chat\` - Toggle addon on/off
        - \`/n2c config\` - Open configuration panel
        - \`/n2c name YourName\` - Set custom name
        
        ---
        
        **Packaged with:** BigWigs Packager v2.4+ for professional WoW addon distribution  
        **Changelog:** Compare changes at https://github.com/gOOvER/Name2Chat/compare/v$VERSION
        EOF
        fi
        
        echo "release_notes_file=release_notes.md" >> $GITHUB_OUTPUT
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.validate-release.outputs.tag_name }}
        name: Name2Chat v${{ needs.validate-release.outputs.version }}
        body_path: release_notes.md
        files: |
          ${{ steps.find_package.outputs.package_file }}
        draft: false
        prerelease: ${{ needs.validate-release.outputs.is_prerelease == 'true' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  platform-upload-summary:
    name: Platform Upload Summary
    runs-on: ubuntu-latest
    needs: [validate-release, package-addon, create-github-release]
    if: always()
    
    steps:
    - name: Platform upload summary
      run: |
        echo "## ðŸ“¦ Release Summary" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** ${{ needs.validate-release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**Tag:** ${{ needs.validate-release.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Type:** $([[ "${{ needs.validate-release.outputs.is_prerelease }}" == "true" ]] && echo "ðŸ§ª Prerelease" || echo "âœ… Stable Release")" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Platform Upload Status" >> $GITHUB_STEP_SUMMARY
        echo "| Platform | Status | Notes |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|--------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| GitHub Releases | âœ… Uploaded | Available for download |" >> $GITHUB_STEP_SUMMARY
        
        # Different upload behavior for prereleases
        if [[ "${{ needs.validate-release.outputs.is_prerelease }}" == "true" ]]; then
          echo "| CurseForge | â¸ï¸ Manual-only | Prereleases not auto-uploaded |" >> $GITHUB_STEP_SUMMARY
          echo "| WoWInterface | â¸ï¸ Manual-only | Prereleases not auto-uploaded |" >> $GITHUB_STEP_SUMMARY
          echo "| Wago | â¸ï¸ Manual-only | Prereleases not auto-uploaded |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš ï¸ Prerelease Notes" >> $GITHUB_STEP_SUMMARY
          echo "- Prereleases are **only uploaded to GitHub**" >> $GITHUB_STEP_SUMMARY
          echo "- Manual upload to addon platforms required" >> $GITHUB_STEP_SUMMARY
          echo "- Use for testing and development only" >> $GITHUB_STEP_SUMMARY
        else
          echo "| CurseForge | ðŸ”‘ Auto-upload | Via BigWigs Packager (if API key set) |" >> $GITHUB_STEP_SUMMARY
          echo "| WoWInterface | ðŸ”‘ Auto-upload | Via BigWigs Packager (if API key set) |" >> $GITHUB_STEP_SUMMARY
          echo "| Wago | ðŸ”‘ Auto-upload | Via BigWigs Packager (if API key set) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Setup API Keys" >> $GITHUB_STEP_SUMMARY
          echo "To enable automatic uploads to addon platforms, add these secrets:" >> $GITHUB_STEP_SUMMARY
          echo "- \`CF_API_KEY\` for CurseForge" >> $GITHUB_STEP_SUMMARY
          echo "- \`WOWI_API_TOKEN\` for WoWInterface" >> $GITHUB_STEP_SUMMARY
          echo "- \`WAGO_API_TOKEN\` for Wago" >> $GITHUB_STEP_SUMMARY
        fi
 